"use strict";(self.webpackJsonpCheckout=self.webpackJsonpCheckout||[]).push([[4527],{14527:(e,t,n)=>{n.d(t,{A:()=>O});var r=n(31635),a=n(44218),i=n(69440),s=n(70355),d=n(43125),c=n(22437);var l=n(62677),o=n(49655),m=n(52921),u=n.n(m),h=n(10156),p=n(14456),g=n(30680);function C(e,t=" "){const{card:n}=(0,c.number)(e);if(!n)return e;const r=function(e,t=" "){const{card:n}=(0,c.number)(e);return n?e.replace(new RegExp(t,"g"),""):e}(e,t);return n.gaps.filter((e=>r.length>e)).reduce(((e,n,r)=>[e.slice(0,n+r),e.slice(n+r)].join(t)),r)}class _ extends s.PureComponent{constructor(){super(...arguments),this.inputRef=(0,s.createRef)(),this.nextSelectionEnd=0,this.handleChange=e=>{const{value:t=""}=e.target,{field:n,form:r}=this.props,{name:a,value:s=""}=n,d=this.inputRef.current&&this.inputRef.current.selectionEnd;if(new RegExp("[^\\d ]").test(t))return r.setFieldValue(a,s);const c=(0,i.max)(u()(t).map((e=>(0,i.max)(e.lengths)))),l=C(t.replace(new RegExp(" ","g"),"").slice(0,c)," ");return d===t.length&&t.length<l.length?this.nextSelectionEnd=l.length:this.nextSelectionEnd=d||0,r.setFieldValue(a,l)}}componentDidUpdate(){this.inputRef.current&&this.inputRef.current.selectionEnd!==this.nextSelectionEnd&&this.inputRef.current.setSelectionRange(this.nextSelectionEnd,this.nextSelectionEnd)}render(){const{field:e}=this.props;return s.createElement(s.Fragment,null,s.createElement(h.A,Object.assign({},e,{additionalClassName:"has-icon",autoComplete:"cc-number",id:e.name,onChange:this.handleChange,ref:this.inputRef,type:"tel"})),s.createElement(p.A,null))}}const f=(0,s.memo)((({name:e})=>{const t=(0,s.useCallback)((({field:e,form:t,meta:n})=>s.createElement(_,{field:e,form:t,meta:n})),[]),n=(0,s.useMemo)((()=>s.createElement(o.A,{id:"payment.credit_card_number_label"})),[]);return s.createElement(g.A,{additionalClassName:"form-field--ccNumber",input:t,labelContent:n,name:e})}));var y=n(97429),E=n(2224),I=n(90767);const v=(0,s.memo)((({name:e})=>{const t=(0,s.useCallback)((({field:e})=>s.createElement(s.Fragment,null,s.createElement(h.A,Object.assign({},e,{additionalClassName:"has-icon",autoComplete:"cc-csc",id:e.name,type:"tel"})),s.createElement(p.A,null))),[]),n=(0,s.useMemo)((()=>s.createElement(s.Fragment,null,s.createElement(o.A,{id:"payment.credit_card_cvv_label"}),s.createElement(y.A,{placement:"top-start",tooltip:s.createElement(I.A,null)},s.createElement("span",{className:"has-tip"},s.createElement(E.A,null))))),[]);return s.createElement(g.A,{additionalClassName:"form-ccFields-field--ccCvv",input:t,labelContent:n,name:e})})),b=({shouldShowNumberField:e,shouldShowCardCodeField:t})=>s.createElement(s.Fragment,null,e&&s.createElement("p",null,s.createElement("strong",null,s.createElement(o.A,{id:"payment.instrument_trusted_shipping_address_title_text"})),s.createElement("br",null),s.createElement(o.A,{id:"payment.instrument_trusted_shipping_address_text"})),s.createElement("div",{className:"form-ccFields"},e&&s.createElement(f,{name:"ccNumber"}),t&&s.createElement(v,{name:"ccCvv"})));var A=n(24750),S=n(40052),w=n(76049);const N=(0,s.memo)((({name:e})=>{const{language:t}=(0,w.Y)(),n=(0,s.useCallback)((0,a.B4)(((e,t)=>n=>{t.setFieldValue(e.name,function(e){const[t="",n=""]=e.split(new RegExp("\\s*/\\s*")),r=t.slice(0,2),a=4===n.length?n.slice(-2):n?n.slice(0,2):t.slice(2);return e.length<2?t:e.length>3&&!a?r:`${r} / ${a}`}(n.target.value))})),[]),r=(0,s.useCallback)((({field:e,form:r})=>s.createElement(h.A,Object.assign({},e,{autoComplete:"cc-exp",id:e.name,onChange:n(e,r),placeholder:t.translate("payment.credit_card_expiration_placeholder_text"),type:"tel"}))),[n,t]),i=(0,s.useMemo)((()=>s.createElement(o.A,{id:"payment.credit_card_expiration_label"})),[]);return s.createElement(g.A,{additionalClassName:"form-field--ccExpiry",input:r,labelContent:i,name:e})})),F=(0,s.memo)((({name:e})=>{const t=(0,s.useCallback)((({field:e})=>s.createElement(h.A,Object.assign({},e,{autoComplete:"cc-name",id:e.name}))),[]),n=(0,s.useMemo)((()=>s.createElement(o.A,{id:"payment.credit_card_name_label"})),[]);return s.createElement(g.A,{additionalClassName:"form-field--ccName",input:t,labelContent:n,name:e})}));var q=n(53783);const R=(0,s.memo)((({shouldShowCardCodeField:e,shouldShowCustomerCodeField:t})=>s.createElement(A.A,{additionalClassName:"creditCardFieldset",legend:s.createElement(S.A,{hidden:!0},s.createElement(o.A,{id:"payment.credit_card_text"}))},s.createElement("div",{className:"form-ccFields"},s.createElement(f,{name:"ccNumber"}),s.createElement(N,{name:"ccExpiry"}),s.createElement(F,{name:"ccName"}),e&&s.createElement(v,{name:"ccCvv"}),t&&s.createElement(q.A,{name:"ccCustomerCode"})))));var x=n(40646),P=n(94202),k=n(29905);const D=(0,a.Bj)((function({instrumentBrand:e,instrumentLast4:t,isCardCodeRequired:n,isCardNumberRequired:r,language:a}){const i={instrumentId:(0,P.Yj)().required()};return n&&(i.ccCvv=(0,P.Yj)().required(a.translate("payment.credit_card_cvv_required_error")).test({message:a.translate("payment.credit_card_cvv_invalid_error"),test(t=""){const n=(0,k.A)(e),r=u().getTypeInfo(n);return(0,c.cvv)(t,r&&r.code?r.code.size:void 0).isValid}})),r&&(i.ccNumber=(0,P.Yj)().required(a.translate("payment.credit_card_number_required_error")).test({message:a.translate("payment.credit_card_number_invalid_error"),test:(e="")=>(0,c.number)(e).isValid}).test({message:a.translate("payment.credit_card_number_mismatch_error"),test:(e="")=>e.slice(-t.length)===t})),(0,P.Ik)(i)})),M=(0,a.Bj)((function({isCardCodeRequired:e,language:t}){const n={ccCustomerCode:(0,P.Yj)(),ccCvv:(0,P.Yj)(),ccExpiry:(0,P.Yj)().required(t.translate("payment.credit_card_expiration_required_error")).test({message:t.translate("payment.credit_card_expiration_invalid_error"),test:e=>(0,c.expirationDate)(e).isValid}),ccName:(0,P.Yj)().max(200).required(t.translate("payment.credit_card_name_required_error")),ccNumber:(0,P.Yj)().required(t.translate("payment.credit_card_number_required_error")).test({message:t.translate("payment.credit_card_number_invalid_error"),test:e=>(0,c.number)(e).isValid})};return e&&(n.ccCvv=(0,P.Yj)().required(t.translate("payment.credit_card_cvv_required_error")).test({message:t.translate("payment.credit_card_cvv_invalid_error"),test(e){const{card:t}=(0,c.number)(this.parent.ccNumber);return(0,c.cvv)(e,t&&t.code?t.code.size:void 0).isValid}})),(0,P.Ik)(n)}));var V=n(94611),j=n(48407),U=n(31448),T=n(28795),Y=n(84087);function z(e){if(!e)throw new Error("Missing configuration data");const{inputDateFormat:t}=e;return{currency:(0,T.P5)(e),date:{inputFormat:t},language:(0,Y.A)()}}var L=n(91182);class B extends s.Component{constructor(){super(...arguments),this.state={isAddingNewCard:!1},this.filterInstruments=(0,a.B4)(((e=[])=>e.filter(d.a))),this.handleUseNewCard=()=>{this.setState({isAddingNewCard:!0,selectedInstrumentId:void 0})},this.handleSelectInstrument=e=>{this.setState({isAddingNewCard:!1,selectedInstrumentId:e})},this.handleDeleteInstrument=e=>{const{paymentForm:{setFieldValue:t}}=this.props,{instruments:n}=this.getCreditCardPaymentMethodDerivedProps(),{selectedInstrumentId:r}=this.state;0===n.length?(this.setState({isAddingNewCard:!0,selectedInstrumentId:void 0}),t("instrumentId","")):r===e&&(this.setState({selectedInstrumentId:this.getDefaultInstrumentId()}),t("instrumentId",this.getDefaultInstrumentId()))}}componentDidMount(){return(0,r.__awaiter)(this,void 0,void 0,(function*(){const{initializePayment:e,method:t,onUnhandledError:n,paymentForm:{setValidationSchema:r}}=this.props,{isInstrumentFeatureAvailable:a,loadInstruments:i}=this.getCreditCardPaymentMethodDerivedProps();r(t,this.getValidationSchema()),function(){const e=c.creditCardType.getTypeInfo("discover"),t=c.creditCardType.getTypeInfo("visa");c.creditCardType.updateCard("visa",{lengths:[13,...t.lengths||[]]}),c.creditCardType.updateCard("discover",{patterns:[...e.patterns||[],[810,817]]}),c.creditCardType.addCard({niceType:"Mada",type:"mada",patterns:[400861,401757,407197,407395,409201,410685,412565,417633,419593,422817,422818,422819,428331,428671,428672,428673,431361,432328,434107,439954,440533,440647,440795,445564,446393,446404,446672,455036,455708,457865,458456,462220,468540,468541,468542,468543,483010,483011,483012,484783,486094,486095,486096,489317,489318,489319,493428,504300,506968,508160,513213,520058,521076,524130,524514,529415,529741,530060,530906,531095,531196,532013,535825,535989,536023,537767,539931,543085,543357,549760,554180,557606,558848,585265,588845,588846,588847,588848,588849,588850,588851,588982,588983,589005,589206,604906,605141,636120,968201,968202,968203,968204,968205,968206,968207,968208,968209,968210,968211],gaps:[4,8,12],lengths:[16,18,19],code:{name:"CVV",size:3}})}();try{a&&(yield i()),yield e({gatewayId:t.gateway,methodId:t.id},this.getSelectedInstrument())}catch(e){e instanceof Error&&n(e)}}))}componentWillUnmount(){return(0,r.__awaiter)(this,void 0,void 0,(function*(){const{deinitializePayment:e,method:t,onUnhandledError:n,paymentForm:{setValidationSchema:r}}=this.props;r(t,null);try{yield e({gatewayId:t.gateway,methodId:t.id})}catch(e){e instanceof Error&&n(e)}}))}componentDidUpdate(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function*(){const{deinitializePayment:e,initializePayment:n,method:r,onUnhandledError:a,paymentForm:{setValidationSchema:i}}=this.props,{isAddingNewCard:s,selectedInstrumentId:d}=this.state;if(i(r,this.getValidationSchema()),d!==t.selectedInstrumentId||s!==t.isAddingNewCard)try{yield e({gatewayId:r.gateway,methodId:r.id}),yield n({gatewayId:r.gateway,methodId:r.id},this.getSelectedInstrument())}catch(e){e instanceof Error&&a(e)}}))}render(){const{checkoutState:e,cardFieldset:t,getStoredCardValidationFieldset:n,isInitializing:r,method:a}=this.props,{instruments:i,isInstrumentCardCodeRequired:d,isInstrumentCardNumberRequired:c,isInstrumentFeatureAvailable:o,isLoadingInstruments:m,shouldShowInstrumentFieldset:u}=this.getCreditCardPaymentMethodDerivedProps(),{data:{getConfig:h}}=e,{isAddingNewCard:p}=this.state,g=this.getSelectedInstrument(),C=!u||p,_=r||m,f=!!g&&c(g,a),y=!!g&&d(g,a),E=h();if(!E)throw Error("Unable to get config or customer");return s.createElement(w.A.Provider,{value:z(E)},s.createElement(L.A,{hideContentWhenLoading:!0,isLoading:_},s.createElement("div",{className:"paymentMethod paymentMethod--creditCard","data-test":"credit-cart-payment-method"},u&&s.createElement(l.A,{instruments:i,onDeleteInstrument:this.handleDeleteInstrument,onSelectInstrument:this.handleSelectInstrument,onUseNewInstrument:this.handleUseNewCard,selectedInstrumentId:g&&g.bigpayToken,validateInstrument:n?n(g):s.createElement(b,{shouldShowCardCodeField:y,shouldShowNumberField:f})}),C&&!t&&s.createElement(R,{shouldShowCardCodeField:a.config.cardCode||null===a.config.cardCode,shouldShowCustomerCodeField:a.config.requireCustomerCode}),C&&t,o&&s.createElement(x.A,{instrumentId:g&&g.bigpayToken,instruments:i}))))}getSelectedInstrument(){const{instruments:e}=this.getCreditCardPaymentMethodDerivedProps(),{selectedInstrumentId:t=this.getDefaultInstrumentId()}=this.state;return(0,i.find)(e,{bigpayToken:t})}getDefaultInstrumentId(){const{isAddingNewCard:e}=this.state;if(e)return;const{instruments:t}=this.getCreditCardPaymentMethodDerivedProps(),n=t.find((e=>e.defaultInstrument))||t[0];return n&&n.bigpayToken}getValidationSchema(){const{cardValidationSchema:e,language:t,method:n,storedCardValidationSchema:r}=this.props,{isInstrumentCardCodeRequired:a,isInstrumentCardNumberRequired:i,isInstrumentFeatureAvailable:s,isPaymentDataRequired:d}=this.getCreditCardPaymentMethodDerivedProps();if(!d)return null;const c=this.getSelectedInstrument();return s&&c?r||D({instrumentBrand:c.brand,instrumentLast4:c.last4,isCardCodeRequired:a(c,n),isCardNumberRequired:i(c,n),language:t}):e||M({isCardCodeRequired:!0===n.config.cardCode,language:t})}getCreditCardPaymentMethodDerivedProps(){const{checkoutService:e,checkoutState:t,isUsingMultiShipping:n=!1,method:r}=this.props,{data:{getConfig:a,getCustomer:i,getInstruments:s,isPaymentDataRequired:d},statuses:{isLoadingInstruments:c}}=t,l=a(),o=i();if(!l||!o||!r)throw new Error("Unable to get checkout");const m=this.filterInstruments(s(r)),u=(0,V.A)({config:l,customer:o,isUsingMultiShipping:n,paymentMethod:r});return{instruments:m,isCardCodeRequired:r.config.cardCode||null===r.config.cardCode,isCustomerCodeRequired:!!r.config.requireCustomerCode,isInstrumentCardCodeRequired:(0,j.A)(t),isInstrumentCardNumberRequired:(0,U.A)(t),isInstrumentFeatureAvailable:u,isLoadingInstruments:c(),isPaymentDataRequired:d(),loadInstruments:e.loadInstruments,shouldShowInstrumentFieldset:u&&m.length>0}}}const O=B},53783:(e,t,n)=>{n.d(t,{A:()=>d});var r=n(70355),a=n(49655),i=n(10156),s=n(30680);const d=(0,r.memo)((({name:e})=>{const t=(0,r.useCallback)((({field:e})=>r.createElement(i.A,Object.assign({},e,{id:e.name}))),[]),n=(0,r.useMemo)((()=>r.createElement(r.Fragment,null,r.createElement(a.A,{id:"payment.credit_card_customer_code_label"})," ",r.createElement("small",{className:"optimizedCheckout-contentSecondary"},r.createElement(a.A,{id:"common.optional_text"})))),[]);return r.createElement(s.A,{input:t,labelContent:n,name:e})}))},94611:(e,t,n)=>{function r({config:e,customer:t,isUsingMultiShipping:n,paymentMethod:r}){return!(!e.checkoutSettings.isCardVaultingEnabled||!r.config.isVaultingEnabled||t.isGuest||n)}n.d(t,{A:()=>r})}}]);
//# sourceMappingURL=4527-95ae34f9.js.map